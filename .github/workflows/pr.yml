name: PR

on:
  pull_request:

concurrency:
  group: pr-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
        with:
          lfs: true
      - uses: ./.github/actions/setup-python/
      - run: poetry install
      - run: poetry run pre-commit run --all-files
        env:
          SKIP: ruff
      - run: |
          poetry run ruff check .
          poetry run ruff format . --check

  enforce-chains-example-docs-sync:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
        with:
          lfs: true
      - name: Check if chains examples were modified
        id: check_files
        run: |
          if git diff --name-only origin/main | grep -q '^truss-chains/examples/.*'; then
            echo "::set-output name=docs_needed::true"
          else
            echo "::set-output name=docs_needed::false"
          fi

      - name: Enfore acknoledgement in PR description
        if: steps.check_files.outputs.docs_needed == 'true'
        run: |
          DESCRIPTION=$(jq -r .body < "${GITHUB_EVENT_PATH}")
          if [[ "$DESCRIPTION" != *"UPDATE_DOCS=done"* && "$DESCRIPTION" != *"UPDATE_DOCS=not_needed"* ]]; then
            echo "Chains examples were modified, in this case the documentation at https://github.com/basetenlabs/docs.baseten.co/tree/main/chains might need to be updated. Add a tag UPDATE_DOCS={done|not_needed} to the PR description to aknwonledge."
            exit 1
          fi

  test:
    timeout-minutes: 30
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
        with:
          lfs: true
      - uses: ./.github/actions/setup-python/
      - run: poetry install
      - name: run tests (poetry run pytest...)
        run: poetry run pytest -v --cov=truss -m 'not integration'

  markdown-link-check:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@master
      - uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-verbose-mode: "yes"
          folder-path: "docs"
