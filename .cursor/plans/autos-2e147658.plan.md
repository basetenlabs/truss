<!-- 2e147658-1e6e-449f-93c2-49d38ac3761a 18b5be24-de0f-48ea-a0d2-8e12c4ebb6d2 -->
# PRD: Autoscaling + Environment Overrides in Truss and Chains

## Goals
- Add first-class autoscaling settings and environment-level overrides to Truss and Chains.
- Resolve effective compute and autoscaling on push (including when `--environment` is supplied).
- Support updating autoscaling without image rebuild and allow env-specific overrides to apply seamlessly.

## Non-goals
- New server-side autoscaler algorithms or metrics.
- Per-endpoint overrides; scope is per model (Truss) and per chainlet (Chains RemoteConfig).
- Environment-specific environment variables (future work).

## User-facing DX

### Truss `config.yaml`
- Top-level defaults; environment-specific overrides live under `environment_overrides` using Bola’s structure.

```yaml
model_name: my-model
resources:
  accelerator:
    accelerator: H100_40GB
    count: 1
autoscaling_settings:
  min_replicas: 1
  max_replicas: 3
  target_utilization_percentage: 60
  scaling_window_seconds: 120
  scale_down_delay_seconds: 300

environment_overrides:
  production:
    autoscaling_settings:
      min_replicas: 15
      max_replicas: 30
      target_utilization_percentage: 70
      scaling_window_seconds: 120
      scale_down_delay_seconds: 600
    resources:
      accelerator:
        accelerator: H100
        count: 1
  staging:
    autoscaling_settings:
      min_replicas: 3
      max_replicas: 6
      target_utilization_percentage: 65
      scaling_window_seconds: 120
      scale_down_delay_seconds: 300
    resources:
      accelerator:
        accelerator: A10G
        count: 1
  qa:
    autoscaling_settings:
      min_replicas: 1
      max_replicas: 2
      target_utilization_percentage: 60
      scaling_window_seconds: 120
      scale_down_delay_seconds: 300
```

- Precedence: when `--environment` is passed (or during publish/promote to an environment), the effective config is `base` merged with `environment_overrides[env]` (deep override for `autoscaling_settings` and `resources`).
- Back-compat: All new fields are optional. Existing configs remain valid.

### Chains (inside `RemoteConfig`)
- Autoscaling settings MUST live inside `RemoteConfig` (per your guidance). Per-chainlet configuration; chain-wide convenience is out of scope for v1.

```python
import truss_chains as chains
from truss.base import truss_config

class Embed(chains.ChainletBase):
    remote_config = chains.RemoteConfig(
        compute=chains.Compute(cpu_count=2, gpu="A10G", gpu_count=1, predict_concurrency=4),
        autoscaling_settings=chains.AutoscalingSettings(
            min_replicas=1,
            max_replicas=5,
            target_utilization_percentage=60,
            scaling_window_seconds=120,
            scale_down_delay_seconds=300,
        ),
        environment_overrides={
            "production": chains.RemoteOverrides(
                compute=chains.Compute(cpu_count=8, gpu="H100", gpu_count=1),
                autoscaling_settings=chains.AutoscalingSettings(
                    min_replicas=20,
                    max_replicas=40,
                    target_utilization_percentage=70,
                    scaling_window_seconds=120,
                    scale_down_delay_seconds=600,
                ),
            )
        },
    )
```

- Precedence: For a given environment, resolve `compute` and `autoscaling_settings` from overrides if present; otherwise use top-level `RemoteConfig` values.
- Mapping to Truss: The Chains deployment codegen will materialize a `TrussConfig` per chainlet and write the effective `resources` and `autoscaling_settings` into the generated `config.yaml` prior to push.

## Behavior on Push

### Truss `truss push`
- If `--environment` is specified, derive effective `resources` and `autoscaling_settings` from the selected environment override.
- Build vs no-build:
  - Changes to `autoscaling_settings` alone shall not trigger image rebuild.
  - Changes to `resources` may change instance type selection and trigger a full deploy on the server, but not a new image build.
- Instance type preservation interplay:
  - Keep existing `--preserve-env-instance-type` flag.
  - Default logic: if an environment override for `resources` is present, do not preserve; otherwise preserve (existing default). The flag continues to override this behavior explicitly.

### Chains `truss chains push`
- For each chainlet, codegen computes effective `compute` and `autoscaling_settings` given the selected environment, writes them into the generated `config.yaml`, and deploys.
- Environment validation errors surface if an unknown environment is specified (existing behavior).

## Schema Additions

### Truss (in `truss/base/truss_config.py`)
- New model `AutoscalingSettings` with fields (exactly):
  - `min_replicas: int >= 0`
  - `max_replicas: int >= min_replicas`
  - `target_utilization_percentage: int 1..100`
  - `scaling_window_seconds: int >= 30`
  - `scale_down_delay_seconds: int >= 0`
- Add to `TrussConfig`:
  - `autoscaling_settings: Optional[AutoscalingSettings]`
  - `environment_overrides: dict[str, TrussEnvironmentOverrides] = {}`
- `TrussEnvironmentOverrides`:
  - `resources: Optional[Resources]`
  - `autoscaling_settings: Optional[AutoscalingSettings]`
- Ensure these fields are included in `to_dict()` and parsed in `from_dict()`; do not affect requirement loading.
- Treat `autoscaling_settings` and env overrides as runtime-only for build invalidation (i.e., do not make them trigger image rebuilds).

### Chains (in `truss-chains/truss_chains/public_types.py`)
- New class `AutoscalingSettings` (fields match Truss exactly).
- New class `RemoteOverrides` with optional `compute` and `autoscaling_settings`.
- Extend `RemoteConfig` with:
  - `autoscaling_settings: Optional[AutoscalingSettings]`
  - `environment_overrides: dict[str, RemoteOverrides] = {}`

### Codegen (in `truss-chains/truss_chains/deployment/code_gen.py`)
- In `_gen_truss_config(...)`:
  - Map `RemoteConfig.compute` -> `TrussConfig.resources` (existing).
  - Map `RemoteConfig.autoscaling_settings` -> `TrussConfig.autoscaling_settings`.
  - If an environment argument is supplied, apply `environment_overrides[env]` to compute effective settings before writing.

## Validation Rules
- `min_replicas <= max_replicas`.
- `target_utilization_percentage` 1–100.
- `scaling_window_seconds >= 30`.
- `scale_down_delay_seconds >= 0`.
- Deep-merge semantics in env overrides: only specified keys override; others inherit from defaults.

## Backwards Compatibility & Migration
- All fields optional; existing configs work unchanged.
- CLI defaults unchanged except the preserve logic minor nuance (documented above). Users can force prior behavior via the flag.

## Telemetry & Observability
- Log resolved `resources` and `autoscaling_settings` on push (without secrets).
- Include resolved settings in the encoded config sent to the server.

## Testing
- Unit tests:
  - Parsing/validation of new fields (Truss, Chains).
  - Env override resolution precedence (Truss, Chains).
  - Build invalidation ignores autoscaling-only changes.
- Integration:
  - `truss push --environment production` applies overrides.
  - `truss chains push --environment production` propagates overrides to generated trusses.

## Open Questions (v2+)
- Add environment-specific env vars and secrets overrides.
- Per-endpoint overrides.
- Additional autoscaling knobs (cooldowns per direction, custom metrics).


### To-dos

- [ ] Add AutoscalingSettings and env overrides to TrussConfig
- [ ] Resolve env overrides on truss push and avoid rebuilds
- [ ] Add AutoscalingSettings and env overrides to RemoteConfig
- [ ] Map Chains RemoteConfig to Truss config in codegen
- [ ] Adjust preserve-env-instance-type default based on overrides
- [ ] Add parsing, precedence, and push integration tests