{%- if model_cache %}
{%- include "cache.Dockerfile.jinja" %}
{%- endif %}

{% extends "base.Dockerfile.jinja" %}

{% block base_image_patch %}
# If user base image is supplied in config, apply build commands from truss base image
{% if config.base_image %}
ENV PYTHONUNBUFFERED True
ENV DEBIAN_FRONTEND=noninteractive

RUN apt update && \
    apt install -y bash \
                build-essential \
                git \
                curl \
                ca-certificates \
                software-properties-common \
    && apt-get autoremove -y \
    && apt-get clean -y \
    && rm -rf /var/lib/apt/lists/*

    {%- if config.live_reload %}
RUN $PYTHON_EXECUTABLE -m venv -h >/dev/null \
    || { pythonVersion=$(echo $($PYTHON_EXECUTABLE --version) | cut -d" " -f2 | cut -d"." -f1,2) \
    && add-apt-repository -y ppa:deadsnakes/ppa \
    && apt update -y && apt install -y --no-install-recommends python$pythonVersion-venv \
    && apt-get autoremove -y \
    && apt-get clean -y \
    && rm -rf /var/lib/apt/lists/*; }
# Create symlink for control server to start inference server process with correct python executable
RUN readlink {{config.base_image.python_executable_path}} &>/dev/null \
    && echo "WARNING: Overwriting existing link at /usr/local/bin/python"
RUN ln -sf {{config.base_image.python_executable_path}} /usr/local/bin/python
    {%- endif %}
{% endif %}

{% endblock %}

{% block install_requirements %}
{{ super() }}
{% endblock %}


{% block app_copy %}
{%- if model_cache %}
# Copy data before code for better caching
    {%- include "copy_cache_files.Dockerfile.jinja"%}
{%- endif %}

{%- if external_data_files %}
{% for url, dst in external_data_files %}
RUN mkdir -p {{ dst.parent }}; curl -L "{{ url }}" -o {{ dst }}
{% endfor %}
{%- endif  %}

# Copy data before code for better caching
{%- if data_dir_exists %}
COPY ./{{config.data_dir}} /app/data
{%- endif %}

COPY ./{{ config.model_module_dir }} /app/model
COPY ./config.yaml /app/config.yaml
{% endblock %}

{% block run %}
    {%- if config.live_reload %}
ENV HASH_TRUSS {{truss_hash}}
ENV CONTROL_SERVER_PORT 8080
ENV INFERENCE_SERVER_PORT 8090
ENV PYTHON_EXECUTABLE {{config.base_image.python_executable_path or "python3"}}
ENV SERVER_START_CMD="{{config.base_image.python_executable_path or "python3"}} -m truss.server.control.server"
ENTRYPOINT ["{{config.base_image.python_executable_path or "python3"}}", "-m", "truss.server.control.server"]
    {%- else %}
ENV INFERENCE_SERVER_PORT 8080
ENV SERVER_START_CMD="{{(config.base_image.python_executable_path or "python3") ~ " -m truss.server.inference_server"}}"
ENTRYPOINT ["{{config.base_image.python_executable_path or "python3"}}", "-m", "truss.server.inference_server"]
    {%- endif %}
{% endblock %}
