FROM python:3.11-slim

RUN apt-get update && apt-get install -y pipx && rm -rf /var/lib/apt/lists/*
RUN pipx ensurepath

ENV PATH="/root/.local/bin:$PATH"

WORKDIR /tests
COPY test_harness.py test_in_container.py test_settings_toml.py /tests/
COPY settings_enabled.toml settings_disabled.toml /tests/

ARG TRUSS_VERSION=0.12.6rc505
ENV TEST_VERSION=${TRUSS_VERSION}

RUN for i in 1 2 3 4 5; do \
      pipx install --pip-args='--pre' truss==${TRUSS_VERSION} && break; \
      echo "Attempt $i failed, retrying in 10s..."; sleep 10; \
    done

ENV PIPX_VENV_PATH="/root/.local/share/pipx/venvs/truss"
CMD ["sh", "-c", "${PIPX_VENV_PATH}/bin/python /tests/test_in_container.py"]
