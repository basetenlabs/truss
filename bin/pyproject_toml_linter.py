# type: ignore
import collections
import pathlib

import tomlkit


def populate_extras(pyproject_path: pathlib.Path) -> None:
    with pyproject_path.open("r") as f:
        content = tomlkit.parse(f.read())

    dependencies = content["tool"]["poetry"]["dependencies"]
    dependency_metadata = content["tool"]["dependency_metadata"]

    extra_sections = collections.defaultdict(set)
    all_deps = set()
    for key in dependencies.keys():
        if key not in dependency_metadata:
            raise ValueError(
                f"`{key}` is missing in `[tool.dependency_metadata]`."
                f"(file: {pyproject_path})."
            )
        metadata = dependency_metadata[key]
        components = metadata["components"].split(",")
        for component in components:
            if component == "base":
                continue
            extra_sections[component].add(key)
            all_deps.add(key)

    extras_section = tomlkit.table()
    for extra_section, deps in extra_sections.items():
        extras_section[extra_section] = tomlkit.array()
        extras_section[extra_section].extend(sorted(deps))

    extras_section["all"] = tomlkit.array()
    extras_section["all"].extend(sorted(all_deps))

    extras_key = "tool.poetry.extras"
    this_tool = pathlib.Path(__file__).name
    autogenerated_comment = tomlkit.comment(
        f"Note: `{extras_key}` was autogenerated by `{this_tool}`, do not edit manually."
    )
    content.add(tomlkit.nl())
    content.add(tomlkit.nl())
    content.add(autogenerated_comment)

    content.add(tomlkit.key(extras_key), extras_section)
    with pyproject_path.open("w") as f:
        f.write(tomlkit.dumps(content))


if __name__ == "__main__":
    pyproject_file = pathlib.Path(__file__).parent.parent.resolve() / "pyproject.toml"
    populate_extras(pyproject_file)
